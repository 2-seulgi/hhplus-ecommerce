# ë™ì‹œì„± ë¬¸ì œ ë¶„ì„ ë° í•´ê²° ë°©ì•ˆ

## 1. ë¬¸ì œ ì‹ë³„

ë³¸ ì´ì»¤ë¨¸ìŠ¤ ì‹œìŠ¤í…œì—ì„œëŠ” ì£¼ë¬¸, ê²°ì œ, í”„ë¡œëª¨ì…˜(ì¿ í°), í¬ì¸íŠ¸, ì¬ê³  ê´€ë¦¬ ë“± ì—¬ëŸ¬ ê¸°ëŠ¥ì´ ë™ì‹œì— ë™ì‘í•œë‹¤.
ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ê°™ì€ ë¦¬ì†ŒìŠ¤(Product, User, Coupon ë“±)ì— ë™ì‹œì— ì ‘ê·¼í•˜ëŠ” ê³¼ì •ì—ì„œ Race Conditionì´ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ê³§ ë°ì´í„° ì •í•©ì„±(Data Consistency) í›¼ì†ìœ¼ë¡œ ì´ì–´ì§„ë‹¤.

ì•„ë˜ì—ì„œëŠ” ì„œë¹„ìŠ¤ ë‚´ì—ì„œ ì‹¤ì œë¡œ ë°œìƒ ê°€ëŠ¥í•œ ëŒ€í‘œì ì¸ ë™ì‹œì„± ë¬¸ì œë¥¼ ì‹ë³„í•˜ê³ , ê·¸ ì˜í–¥ë„ë¥¼ ì •ë¦¬í•˜ì˜€ë‹¤.

### 1.1 ì¬ê³  ì°¨ê° (Product.stock)

#### A. Overselling ë¬¸ì œ (ì¬ê³  ìŒìˆ˜ / ì´ˆê³¼ íŒë§¤) 
ê²€ì¦(stock >= quantity)ì´ ì˜¤ë˜ëœ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜í–‰ë˜ì–´, ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ì´ ë™ì‹œì— ì¬ê³  ì°¨ê° ë¡œì§ì„ í†µê³¼í•´ ë²„ë¦¬ëŠ” í˜„ìƒ.

**ë¬¸ì œ ìƒí™©:**
```java
// Product.java
public void decreaseStock(int quantity) {
    if (this.stock < quantity) {
        throw new BusinessException("ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤", "OUT_OF_STOCK");
    }
    this.stock -= quantity;  // âš ï¸ Race Condition!
}
```

**ì‹œë‚˜ë¦¬ì˜¤:**
1. íŠ¹ì • ìƒí’ˆì˜ ì¬ê³ ê°€ 1ê°œ ë‚¨ì€ ìƒí™©ì—ì„œ
2. ì‚¬ìš©ì A, Bê°€ ë™ì‹œì— ì£¼ë¬¸ ì‹œë„
3. ë‘ íŠ¸ëœì­ì…˜ ëª¨ë‘ this.stock < quantity ê²€ì¦ì„ í†µê³¼í•œë‹¤. (ê°ì ì½ì„ ë•Œ stock=1)
4. ì´í›„ ê°ê° this.stock -= quantity ì—°ì‚°ì„ ìˆ˜í–‰í•œë‹¤.
5. **ê²°ê³¼ì ìœ¼ë¡œ ì¬ê³ ê°€ 0ì´ ì•„ë‹ˆë¼ -1 ë“± ìŒìˆ˜ë¡œ ë‚´ë ¤ê°ˆ ìˆ˜ ìˆë‹¤.**

#### B. Lost Update ë¬¸ì œ (ì—…ë°ì´íŠ¸ ë®ì–´ì“°ê¸°)
ê° íŠ¸ëœì­ì…˜ì´ ê³„ì‚°í•œ ì¬ê³  ê°’ì´ ì„œë¡œ ë®ì–´ì¨ì ¸, ì¤‘ê°„ ì—…ë°ì´íŠ¸ê°€ ì‚¬ë¼ì§€ëŠ” í˜„ìƒ.

**ë¬¸ì œ ìƒí™©:**
```java
// Product.java
// ì¬ê³  ì°¨ê° (ê²°ì œ ì‹œ)
public void decreaseStock(int quantity) {
    if (this.stock < quantity) {
        throw new BusinessException("ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤", "OUT_OF_STOCK");
    }
    this.stock -= quantity;
    this.updatedAt = Instant.now();
}
```
**ì‹œë‚˜ë¦¬ì˜¤:**
1. íŠ¹ì • ìƒí’ˆì˜ ì¬ê³ ê°€ 5ê°œ ë‚¨ì€ ìƒí™©ì—ì„œ
2. Transaction A: stock ì¡°íšŒ â†’ 5, Transaction B: stock ì¡°íšŒ â†’ 5
3. Transaction A: stock -= 1 â†’ stock=4
4. Transaction B: stock -= 2 â†’ stock=3
5. ì—…ë°ì´íŠ¸ ì‹¤í–‰ â†’ stock=3 (Aì˜ ì—…ë°ì´íŠ¸ê°€ ë®ì–´ì¨ì§
6. **ê²°ê³¼ìœ¼ë¡œ ì¤‘ê°„ ì—…ë°ì´íŠ¸ê°€ ì‚¬ë¼ì ¸ (Lost Update) ì¬ê³ ê°€ 1ì´ ì•„ë‹ˆë¼ 3ìœ¼ë¡œ ë‚¨ê²Œ ëœë‹¤.**

**ì˜í–¥ë„:**
- ğŸ”´ **Critical**
  - ì‹¤ì œ ë³´ìœ  ì¬ê³ ë³´ë‹¤ ë§ì€ ìˆ˜ëŸ‰ì´ íŒë§¤ë˜ì–´ ë°°ì†¡ ë¶ˆê°€, ì£¼ë¬¸ ì·¨ì†Œ ë“±ì˜ ë¬¸ì œê°€ ë°œìƒí•œë‹¤
  - ìš´ì˜ìê°€ ìˆ˜ì‘ì—…ìœ¼ë¡œ ì¬ê³ /ì£¼ë¬¸ì„ ì¡°ì •í•´ì•¼ í•˜ë©°, ì´ëŠ” ê³ ê° ë¶ˆë§Œ, ì‹ ë¢°ë„ í•˜ë½ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆë‹¤.
  - ì¬ê³  ë°ì´í„°ê°€ í•œ ë²ˆ ê¹¨ì§€ë©´ ì´í›„ ê°œë°œ ë  ìˆ˜ ìˆëŠ” í†µê³„ë‚˜, ì¶”ì²œ ë¡œì§ ë“± 2ì°¨ ê¸°ëŠ¥ì—ë„ ì•…ì˜í–¥ì„ ì¤€ë‹¤.

---

### 1.2 í¬ì¸íŠ¸ ì°¨ê° (User.balance)

**ë¬¸ì œ ìƒí™©:**
```java
// User.java
public void use(int amount) {
    if (this.balance < amount) {
        throw new InsufficientBalanceException("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");
    }
    this.balance -= amount;  // âš ï¸ Race Condition!
}
```

**ì‹œë‚˜ë¦¬ì˜¤:**
1. ì‚¬ìš©ì ì”ì•¡ì´ 10,000ì›ì¸ ìƒíƒœì—ì„œ
2. ë™ì¼ ì‚¬ìš©ìê°€ ë‘ ê°œì˜ ì£¼ë¬¸ì„ ê±°ì˜ ë™ì‹œì— ì‹œë„í•œë‹¤. (ê° ì£¼ë¬¸ ê¸ˆì•¡ 7,000ì›)
3. ë‘ íŠ¸ëœì­ì…˜ ëª¨ë‘ this.balance < amount ê²€ì¦ì„ í†µê³¼í•œë‹¤. (ê²€ì¦ ì‹œì ì—ëŠ” balance=10,000)
4. ê° íŠ¸ëœì­ì…˜ì—ì„œ this.balance -= amount ì—°ì‚°ì„ ìˆ˜í–‰í•œë‹¤.
5. **ìµœì¢…ì ìœ¼ë¡œ ì”ì•¡ì´ -4,000ì›ì²˜ëŸ¼ ìŒìˆ˜ë¡œ ë‚´ë ¤ê°ˆ ìˆ˜ ìˆë‹¤.**

**ì˜í–¥ë„:**
- ğŸŸ  **High** 
  - ê¸ˆì „ ê´€ë ¨ ë°ì´í„° ì •í•©ì„± ë¬¸ì œ
  - ì‹¤ì œ ì„œë¹„ìŠ¤ íë¦„(ì¥ë°”êµ¬ë‹ˆ â†’ ì£¼ë¬¸ ìƒì„±) ìƒ,
    ë™ì¼ ì‚¬ìš©ìê°€ ë™ì‹œì— ì—¬ëŸ¬ ì£¼ë¬¸ì„ ì‹œë„í•˜ëŠ” ë¹ˆë„ëŠ” ì¬ê³  ì°¨ê°ë³´ë‹¤ëŠ” ìƒëŒ€ì ìœ¼ë¡œ ë‚®ì„ ìˆ˜ ìˆë‹¤.
  - ê·¸ëŸ¼ì—ë„ í•œ ë²ˆ ë°œìƒí•  ê²½ìš° ê¸ˆì „/ì •ì‚° ì´ìŠˆë¡œ ì´ì–´ì§€ê¸° ë•Œë¬¸ì— ì˜í–¥ë„ëŠ” ë†’ë‹¤.

---

### 1.3 ì¿ í° ë°œê¸‰ (Coupon.issuedQuantity)

**ë¬¸ì œ ìƒí™©:**
```java
// Coupon.java
public void increaseIssuedQuantity() {
    if (this.issuedQuantity >= this.totalQuantity) {
        throw new BusinessException("ì¿ í°ì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤", "COUPON_SOLD_OUT");
    }
    this.issuedQuantity++;  // âš ï¸ Race Condition!
}
```

**ì‹œë‚˜ë¦¬ì˜¤:**
1. â€œì„ ì°©ìˆœ 100ëª… í•œì • ì¿ í°â€ê³¼ ê°™ì´ totalQuantity = 100ìœ¼ë¡œ ì„¤ì •ëœ ì¿ í°ì´ ì¡´ì¬í•œë‹¤.
2. í˜„ì¬ê¹Œì§€ ë°œê¸‰ ìˆ˜ëŸ‰ issuedQuantity = 99ì¸ ìƒí™©ì—ì„œ,
3. ì´ë²¤íŠ¸ í˜ì´ì§€ì— íŠ¸ë˜í”½ì´ ëª°ë ¤ ë™ì‹œì— ìˆ˜ë°±~ìˆ˜ì²œ ëª…ì´ ë°œê¸‰ ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
4. ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ì´ ë™ì‹œì— issuedQuantity < totalQuantity ì¡°ê±´ì„ í†µê³¼í•œë‹¤.
5. ê° íŠ¸ëœì­ì…˜ì´ issuedQuantity++ë¥¼ ìˆ˜í–‰í•œ ê²°ê³¼,
6. **ìµœì¢…ì ìœ¼ë¡œ issuedQuantityê°€ 100ì„ ì´ˆê³¼í•˜ì—¬ 101, 102 ë“±ìœ¼ë¡œ ì¦ê°€í•  ìˆ˜ ìˆë‹¤.**

**ì˜í–¥ë„:**
- ğŸŸ  **High**
  - â€œì„ ì°©ìˆœ Nëª…â€ ì´ë²¤íŠ¸ì˜ í•µì‹¬ ì¡°ê±´ì´ ê¹¨ì ¸ ë§ˆì¼€íŒ… ì‹ ë¢°ë„ê°€ ë–¨ì–´ì§„ë‹¤.
  - ì˜ˆìƒë³´ë‹¤ ë§ì€ ì¿ í°ì´ ë°œê¸‰ë˜ë©´ ë¹„ìš© ì´ˆê³¼ ë° ì •ì‚° ì´ìŠˆë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆë‹¤.

**í˜„ì¬ ìƒíƒœ:**
- í•´ë‹¹ ê¸°ëŠ¥ì—ëŠ” ì´ë¯¸ ë‚™ê´€ì  ë½(Optimistic Lock) + ì¬ì‹œë„(Retry) íŒ¨í„´ì´ ì ìš©ë˜ì–´ ìˆë‹¤.
- ë‹¤ë§Œ, ì„ ì°©ìˆœ ì´ë²¤íŠ¸ íŠ¹ì„±ìƒ ë™ì‹œì„±ì´ ë§¤ìš° ë†’ì€ êµ¬ê°„ì—ì„œ ë°˜ë³µì ì¸ ì¬ì‹œë„ê°€ ë°œìƒí•  ìˆ˜ ìˆì–´,
  - ë¹„ê´€ì  ë½(Pessimistic Lock, SELECT ... FOR UPDATE)ìœ¼ë¡œ ì „í™˜í•˜ëŠ” ë°©ì•ˆì„ ê²€í†  ì¤‘ì´ë‹¤.
  - ì„ ì°©ìˆœ ì´ë²¤íŠ¸ì—ì„œëŠ” â€œì¶©ëŒì´ ìì£¼ ì¼ì–´ë‚œë‹¤â€ëŠ” ê°€ì •ì´ ë” í˜„ì‹¤ì ì´ë¯€ë¡œ,
    ë‚™ê´€ì  ë½ë³´ë‹¤ëŠ” ë¹„ê´€ì  ë½ + ì§§ì€ ì„ê³„ êµ¬ì—­(critical section)ì´ ë” ì í•©í•  ìˆ˜ ìˆë‹¤.

---

## 2. ë¬¸ì œ ë¶„ì„

ì´ì»¤ë¨¸ìŠ¤ ë„ë©”ì¸ ë‚´ì—ì„œ ë°œìƒ ê°€ëŠ¥í•œ ì£¼ìš” ë™ì‹œì„± ë¬¸ì œë¥¼ Race Condition,
íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€, ê·¸ë¦¬ê³  JPAì˜ ë™ì‘ ë°©ì‹ ê´€ì ì—ì„œ ë¶„ì„í•œë‹¤.

### 2.1 Race Condition

**ì •ì˜:**
Race Conditionì€ ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ì´ ë™ì¼í•œ ê³µìœ  ìì›ì„ ë™ì‹œì— ê°±ì‹ í•  ë•Œ
ì‹¤í–‰ ìˆœì„œì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§€ëŠ” í˜„ìƒì„ ì˜ë¯¸í•œë‹¤.
ì´ëŠ” íŠ¹íˆ â€œì¡°íšŒ í›„ ìˆ˜ì •(SELECT â†’ UPDATE)â€ êµ¬ì¡°ë¥¼ ê°€ì§„ ë¡œì§ì—ì„œ ì¹˜ëª…ì ì¸ ì •í•©ì„± ë¬¸ì œë¥¼ ìœ ë°œí•œë‹¤.

**ë°œìƒ ì›ì¸:**
```
Transaction A          Transaction B
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
READ stock = 5
                       READ stock = 5
UPDATE stock = 4
                       UPDATE stock = 4  â† Lost Update!
```

**Lost Update ë¬¸ì œ:**
- Transaction Bì˜ ì—…ë°ì´íŠ¸ê°€ Transaction Aì˜ ì—…ë°ì´íŠ¸ë¥¼ ë®ì–´ì”€
- ìµœì¢… stock = 4 (ê¸°ëŒ€ê°’: 3)

---

### 2.2 íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€

**MySQL ê¸°ë³¸ ê²©ë¦¬ ìˆ˜ì¤€: REPEATABLE READ**

| ê²©ë¦¬ ìˆ˜ì¤€ | Dirty Read | Non-Repeatable Read | Phantom Read | Lost Update |
|---------|-----------|---------------------|-------------|-------------|
| READ UNCOMMITTED | O | O | O | O |
| READ COMMITTED | X | O | O | O |
| **REPEATABLE READ** | X | X | O | **O** |
| SERIALIZABLE | X | X | X | X |

**ì¤‘ìš”:**
- REPEATABLE READë„ **Lost UpdateëŠ” ë°©ì§€í•˜ì§€ ëª»í•¨**
- ëª…ì‹œì ì¸ ë½ ë˜ëŠ” ë²„ì „ ê´€ë¦¬ í•„ìš”

---

### 2.3 ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ì´ìœ 

**JPA/Hibernateì˜ ê¸°ë³¸ ë™ì‘:**
```java
// 1. ì¡°íšŒ
Product product = productRepository.findById(productId);

// 2. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ìˆœìˆ˜ Java ê°ì²´ ìˆ˜ì •)
product.decreaseStock(quantity);

// 3. íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— UPDATE ì‹¤í–‰
// UPDATE product SET stock = stock - ? WHERE id = ?
```

**ë¬¸ì œì :**
- ì¡°íšŒ(SELECT)ì™€ ìˆ˜ì •(UPDATE) ì‚¬ì´ì— ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¼ì–´ë“¤ ìˆ˜ ìˆìŒ
- JPAëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Lost Updateë¥¼ ë°©ì§€í•˜ì§€ ì•ŠìŒ

---

## 3. í•´ê²° ë°©ì•ˆ ë¹„êµ

### 3.1 Optimistic Lock (ë‚™ê´€ì  ë½)

**ê°œë…:**
- ì¶©ëŒì´ **ë“œë¬¼ ê²ƒ**ìœ¼ë¡œ ê°€ì •
- ë²„ì „ ì»¬ëŸ¼(`@Version`)ìœ¼ë¡œ ì¶©ëŒ ê°ì§€
- ì¶©ëŒ ì‹œ ì˜ˆì™¸ ë°œìƒ â†’ ì¬ì‹œë„

**ë™ì‘ ë°©ì‹:**
```sql
-- ì¡°íšŒ
SELECT * FROM product WHERE id = 1;
-- stock = 5, version = 10

-- ìˆ˜ì • (version ì²´í¬)
UPDATE product
SET stock = 4, version = 11
WHERE id = 1 AND version = 10;

-- ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¨¼ì € ìˆ˜ì •í–ˆë‹¤ë©´ affected rows = 0
-- â†’ OptimisticLockException ë°œìƒ
```

**ì¥ì :**
- ë½ì„ ê±¸ì§€ ì•Šì•„ ì„±ëŠ¥ ìš°ìˆ˜
- ë°ë“œë½ ë°œìƒ ì—†ìŒ
- ì½ê¸° ì‘ì—…ì— ì˜í–¥ ì—†ìŒ

**ë‹¨ì :**
- ì¶©ëŒ ì‹œ ì¬ì‹œë„ í•„ìš” (ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ ë³µì¡)
- ì¶©ëŒì´ ë¹ˆë²ˆí•˜ë©´ ì„±ëŠ¥ ì €í•˜
- ì¬ì‹œë„ íšŸìˆ˜ ì œí•œ í•„ìš”

**ì í•©í•œ ê²½ìš°:**
- ì¶©ëŒ ë¹ˆë„ê°€ ë‚®ìŒ
- ì½ê¸° ì‘ì—…ì´ ë§ìŒ
- íŠ¸ëœì­ì…˜ì´ ì§§ìŒ

---

### 3.2 Pessimistic Lock (ë¹„ê´€ì  ë½)

**ê°œë…:**
- ì¶©ëŒì´ **ë¹ˆë²ˆí•  ê²ƒ**ìœ¼ë¡œ ê°€ì •
- ì¡°íšŒ ì‹œì ì— DB ë½ íšë“
- ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì€ ëŒ€ê¸°

**ë™ì‘ ë°©ì‹:**
```sql
-- ì¡°íšŒ + ë½ íšë“
SELECT * FROM product WHERE id = 1 FOR UPDATE;

-- ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì€ ì´ í–‰ì— ëŒ€í•´ ëŒ€ê¸°
-- íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ ë½ í•´ì œ
UPDATE product SET stock = 4 WHERE id = 1;
COMMIT;
```

**ì¥ì :**
- ì¶©ëŒ ìì²´ë¥¼ ë°©ì§€ (ì¬ì‹œë„ ë¶ˆí•„ìš”)
- ë°ì´í„° ì •í•©ì„± ë³´ì¥
- ë¡œì§ì´ ë‹¨ìˆœ

**ë‹¨ì :**
- ë½ ëŒ€ê¸°ë¡œ ì„±ëŠ¥ ì €í•˜
- ë°ë“œë½ ë°œìƒ ê°€ëŠ¥
- ì½ê¸° ì‘ì—…ë„ ì°¨ë‹¨ë  ìˆ˜ ìˆìŒ

**ì í•©í•œ ê²½ìš°:**
- ì¶©ëŒ ë¹ˆë„ê°€ ë†’ìŒ
- ë°ì´í„° ì •í•©ì„±ì´ ì¤‘ìš”
- ì¬ì‹œë„ ë¹„ìš©ì´ í¼

---

### 3.3 ë¶„ì‚° ë½ (Redis, Redisson)

**ê°œë…:**
- ì™¸ë¶€ ì €ì¥ì†Œ(Redis)ë¥¼ ì‚¬ìš©í•œ ë½
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì œì–´
- ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ ê°„ ë™ê¸°í™”

**ì í•©í•œ ê²½ìš°:**
- ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½
- DB ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ ì œì–´
- ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

**í˜„ì¬ í”„ë¡œì íŠ¸:**
- ë‹¨ì¼ DB í™˜ê²½
- DB ë¦¬ì†ŒìŠ¤ë§Œ ì œì–´
- â†’ **DB Lockìœ¼ë¡œ ì¶©ë¶„**

---

## 4. ì„ íƒí•œ í•´ê²° ë°©ì•ˆ

### 4.1 ì¬ê³  ì°¨ê°: Pessimistic Lock

**ì„ íƒ ì´ìœ :**
1. **ì¶©ëŒ ë¹ˆë„ ë†’ìŒ**: ì¸ê¸° ìƒí’ˆì€ ë™ì‹œ ì£¼ë¬¸ ë¹ˆë²ˆ
2. **ì¬ì‹œë„ ë¹„ìš© í¼**: ì¬ê³  í™•ì¸ â†’ ì£¼ë¬¸ ìƒì„± â†’ ê²°ì œ ë“± ë³µì¡í•œ í”Œë¡œìš°
3. **ì •í•©ì„± ì¤‘ìš”**: ì¬ê³  ë¶€ì¡± ì‹œ ë°°ì†¡ ë¶ˆê°€

**êµ¬í˜„ ë°©ë²•:**
```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT p FROM Product p WHERE p.id = :id")
Optional<Product> findByIdForUpdate(@Param("id") Long id);
```

**íŠ¸ë ˆì´ë“œì˜¤í”„:**
- ì„±ëŠ¥ ì €í•˜ ê°ìˆ˜ (ë™ì‹œì„± < ì •í•©ì„±)
- ë½ ëŒ€ê¸° ì‹œê°„ ë°œìƒ
- í•˜ì§€ë§Œ ì¬ê³  ì°¨ê°ì€ ì§§ì€ íŠ¸ëœì­ì…˜

---

### 4.2 í¬ì¸íŠ¸ ì°¨ê°: Optimistic Lock

**ì„ íƒ ì´ìœ :**
1. **ì¶©ëŒ ë¹ˆë„ ë‚®ìŒ**: í•œ ì‚¬ìš©ìê°€ ë™ì‹œì— ì—¬ëŸ¬ ê²°ì œí•˜ëŠ” ê²½ìš° ë“œë¬¾
2. **ì¬ì‹œë„ ë¹„ìš© ì‘ìŒ**: í¬ì¸íŠ¸ ì°¨ê°ë§Œ ì¬ì‹œë„í•˜ë©´ ë¨
3. **ì„±ëŠ¥ ìš°ì„ **: ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì¶©ëŒ ì—†ìŒ

**êµ¬í˜„ ë°©ë²•:**
```java
// User Entity
@Version
private int version;

// ì¬ì‹œë„ ë¡œì§
@Retryable(
    retryFor = ObjectOptimisticLockingFailureException.class,
    maxAttempts = 3,
    backoff = @Backoff(delay = 100)
)
```

**íŠ¸ë ˆì´ë“œì˜¤í”„:**
- ì¶©ëŒ ì‹œ ì¬ì‹œë„ í•„ìš”
- í•˜ì§€ë§Œ ì¶©ëŒ ë¹ˆë„ ë‚®ì•„ ì˜í–¥ ì ìŒ

---

### 4.3 ì¿ í° ë°œê¸‰: Optimistic Lock (êµ¬í˜„ë¨) -> ê°œì„  ê²€í† 

**ì„ íƒ ì´ìœ :**
1. **ì´ë²¤íŠ¸ì„±**: ì§§ì€ ì‹œê°„ì— ëŒ€ëŸ‰ ìš”ì²­
2. **ì¬ì‹œë„ ê°€ëŠ¥**: ë°œê¸‰ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ í—ˆìš©
3. **ì„±ëŠ¥ ì¤‘ìš”**: ë½ìœ¼ë¡œ ì¸í•œ ë³‘ëª© ë°©ì§€

**í˜„ì¬ êµ¬í˜„:**
```java
// Coupon Entity
@Version
private int version;

// UserCouponServiceFacade
@Retryable(
    retryFor = ObjectOptimisticLockingFailureException.class,
    maxAttempts = 50,
    backoff = @Backoff(delay = 10, maxDelay = 200)
)
public IssueCouponResult issueCoupon(IssueCouponCommand command) {
    return userCouponService.issueCoupon(command);
}
```

**ê°œì„  í•„ìš”:**
- maxAttempts=50ì€ ê³¼ë„í•¨ â†’ 10~20ìœ¼ë¡œ ì¡°ì • ê³ ë ¤
- ë°±ì˜¤í”„ ì „ëµ ì¡°ì •
- í˜¹ì€ ë¹„ê´€ì ë½ìœ¼ë¡œ ìˆ˜ì • ì˜ˆì •

---

## 5. í…ŒìŠ¤íŠ¸ ê³„íš

### 5.1 ì¬ê³  ì°¨ê° ë™ì‹œì„± í…ŒìŠ¤íŠ¸

```java
@Test
void ë™ì‹œì—_100ëª…ì´_ì¬ê³ _1ê°œ_ìƒí’ˆ_ì£¼ë¬¸ì‹œ_1ëª…ë§Œ_ì„±ê³µ() {
    // Given: ì¬ê³  1ê°œ ìƒí’ˆ
    Product product = createProduct(stock = 1);

    // When: 100ëª… ë™ì‹œ ì£¼ë¬¸
    ExecutorService executor = Executors.newFixedThreadPool(100);
    List<Future<Result>> futures = new ArrayList<>();

    for (int i = 0; i < 100; i++) {
        futures.add(executor.submit(() -> orderProduct(product.getId())));
    }

    // Then: 1ëª…ë§Œ ì„±ê³µ, 99ëª… ì‹¤íŒ¨
    long successCount = futures.stream()
        .map(f -> f.get())
        .filter(Result::isSuccess)
        .count();

    assertThat(successCount).isEqualTo(1);
    assertThat(product.getStock()).isEqualTo(0);
}
```

### 5.2 í¬ì¸íŠ¸ ì°¨ê° ë™ì‹œì„± í…ŒìŠ¤íŠ¸

```java
@Test
void ë™ì‹œì—_2ê°œ_ì£¼ë¬¸ì‹œ_í¬ì¸íŠ¸_ì •í•©ì„±_ë³´ì¥() {
    // Given: ì”ì•¡ 10,000ì›
    User user = createUser(balance = 10_000);

    // When: 7,000ì›ì§œë¦¬ ì£¼ë¬¸ 2ê°œ ë™ì‹œ ì‹œë„
    CompletableFuture<Result> order1 = async(() -> payment(userId, 7000));
    CompletableFuture<Result> order2 = async(() -> payment(userId, 7000));

    // Then: 1ê°œë§Œ ì„±ê³µ (ë˜ëŠ” ë‘˜ ë‹¤ ì‹¤íŒ¨)
    List<Result> results = List.of(order1.get(), order2.get());
    long successCount = results.stream().filter(Result::isSuccess).count();

    assertThat(successCount).isLessThanOrEqualTo(1);
    assertThat(user.getBalance()).isGreaterThanOrEqualTo(0);
}
```

---

## 6. ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### 6.1 Pessimistic Lock ì„±ëŠ¥

**ë½ ëŒ€ê¸° ì‹œê°„:**
- í‰ê·  íŠ¸ëœì­ì…˜ ì‹œê°„: ~100ms
- ë™ì‹œ ìš”ì²­ 100ê°œ: ìˆœì°¨ ì²˜ë¦¬ ì‹œ 10ì´ˆ
- â†’ **íƒ€ì„ì•„ì›ƒ ì„¤ì • í•„ìš”**

**ê°œì„  ë°©ì•ˆ:**
- íŠ¸ëœì­ì…˜ ìµœì†Œí™”
- ë½ ë²”ìœ„ ìµœì†Œí™”
- íƒ€ì„ì•„ì›ƒ ì„¤ì •

### 6.2 Optimistic Lock ì¬ì‹œë„

**ì¬ì‹œë„ ì˜¤ë²„í—¤ë“œ:**
- ì¶©ëŒë¥  10% ê°€ì •
- ì¬ì‹œë„ 1íšŒë‹¹ ~50ms
- â†’ í‰ê·  5ms ì¶”ê°€ ì§€ì—°

**ê°œì„  ë°©ì•ˆ:**
- ë°±ì˜¤í”„ ì „ëµ (exponential backoff)
- ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì œí•œ
- ëª¨ë‹ˆí„°ë§ ë° ì•ŒëŒ

---

## 7. ëª¨ë‹ˆí„°ë§ ì§€í‘œ

### 7.1 ë½ ê´€ë ¨ ì§€í‘œ

- **ë½ ëŒ€ê¸° ì‹œê°„**: `innodb_row_lock_waits`
- **ë½ íƒ€ì„ì•„ì›ƒ**: `innodb_lock_wait_timeout`
- **ë°ë“œë½ ë°œìƒ**: `innodb_deadlock_detect`

### 7.2 ì¬ì‹œë„ ê´€ë ¨ ì§€í‘œ

- **OptimisticLockException ë°œìƒ íšŸìˆ˜**
- **í‰ê·  ì¬ì‹œë„ íšŸìˆ˜**
- **ì¬ì‹œë„ ì‹¤íŒ¨ìœ¨**

---

## 8. ê²°ë¡ 

| ë¦¬ì†ŒìŠ¤ | í•´ê²° ë°©ì•ˆ | ì´ìœ  | ìš°ì„ ìˆœìœ„ |
|--------|----------|------|---------|
| ì¬ê³  (Product.stock) | Pessimistic Lock | ì¶©ëŒ ë¹ˆë²ˆ, ì •í•©ì„± ì¤‘ìš” | ğŸ”´ High |
| í¬ì¸íŠ¸ (User.balance) | Optimistic Lock | ì¶©ëŒ ë“œë¬¾, ì¬ì‹œë„ ê°€ëŠ¥ | ğŸŸ  Medium |
| ì¿ í° (Coupon.issuedQuantity) | Optimistic Lock | ì´ë²¤íŠ¸ì„±, ì„±ëŠ¥ ì¤‘ìš” | âœ… ì™„ë£Œ |

**ë‹¤ìŒ ë‹¨ê³„:**
1. ì¬ê³  ì°¨ê° Pessimistic Lock êµ¬í˜„
2. í¬ì¸íŠ¸ ì°¨ê° Optimistic Lock êµ¬í˜„
3. í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±
4. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë° ëª¨ë‹ˆí„°ë§