# E-Commerce μ„λΉ„μ¤

ν•­ν•΄ν”λ¬μ¤ λ°±μ—”λ“ κ³Όμ  - μ΄μ»¤λ¨Έμ¤ μ„λΉ„μ¤ κµ¬ν„ (STEP 5/6)

## π“‹ ν”„λ΅μ νΈ κ°μ”

μ΄ ν”„λ΅μ νΈλ” λ μ΄μ–΄λ“ μ•„ν‚¤ν…μ² κΈ°λ°μ μ΄μ»¤λ¨Έμ¤ μ„λΉ„μ¤μ…λ‹λ‹¤.
DBλ¥Ό μ‚¬μ©ν•μ§€ μ•κ³  μΈλ©”λ¨λ¦¬ μ €μ¥μ†λ΅ λ¨λ“  λ°μ΄ν„°λ¥Ό κ΄€λ¦¬ν•λ©°, λ™μ‹μ„± μ μ–΄λ¥Ό κ³ λ ¤ν• μ„¤κ³„λ¥Ό ν¬ν•¨ν•©λ‹λ‹¤.

### μ£Όμ” κΈ°λ¥

- **ν¬μΈνΈ κ΄€λ¦¬**: ν¬μΈνΈ μ¶©μ „, μ‚¬μ©, μ”μ•΅ μ΅°ν, λ‚΄μ—­ μ΅°ν
- **μƒν’ κ΄€λ¦¬**: μƒν’ λ©λ΅ μ΅°ν, μƒμ„Έ μ΅°ν, μ¬κ³  μ΅°ν, μΈκΈ° μƒν’ μ΅°ν
- **μ¥λ°”κµ¬λ‹**: μƒν’ μ¶”κ°€, μ΅°ν, μ‚­μ 
- **μ£Όλ¬Έ/κ²°μ **: μ£Όλ¬Έ μƒμ„±, κ²°μ  μ²λ¦¬, ν™λ¶, μ·¨μ†, λ‚΄μ—­ μ΅°ν
- **μΏ ν° μ‹μ¤ν…**: μΏ ν° λ°κΈ‰, μ‚¬μ©, λ³΄μ  μΏ ν° μ΅°ν (μ„ μ°©μ λ°κΈ‰ μ§€μ›)

## π—οΈ μ•„ν‚¤ν…μ² μ„¤κ³„

### λ μ΄μ–΄λ“ μ•„ν‚¤ν…μ²

μ΄ ν”„λ΅μ νΈλ” **λ„λ©”μΈ μ¤‘μ‹¬ λ μ΄μ–΄λ“ μ•„ν‚¤ν…μ²**λ¥Ό μ±„νƒν–μµλ‹λ‹¤.

```
src/main/java/com/hhplus/be/
β”β”€β”€ {domain}/                    # λ„λ©”μΈλ³„ ν¨ν‚¤μ§€ (cart, product, order, point, user, coupon λ“±)
β”‚   β”β”€β”€ controller/              # Presentation Layer - μ”μ²­/μ‘λ‹µ μ²λ¦¬
β”‚   β”‚   β””β”€β”€ dto/                 # Controllerμ© DTO
β”‚   β”β”€β”€ service/                 # Application Layer - λΉ„μ¦λ‹μ¤ λ΅μ§ μ΅°μ¨
β”‚   β”‚   β””β”€β”€ dto/                 # Serviceμ© DTO (Query, Command, Result)
β”‚   β”β”€β”€ domain/                  # Domain Layer - ν•µμ‹¬ λΉ„μ¦λ‹μ¤ κ·μΉ™
β”‚   β”‚   β”β”€β”€ {Entity}.java        # λ„λ©”μΈ μ—”ν‹°ν‹°
β”‚   β”‚   β””β”€β”€ {ValueObject}.java   # κ°’ κ°μ²΄
β”‚   β””β”€β”€ infrastructure/          # Infrastructure Layer - λ°μ΄ν„° μ €μ¥μ†
β”‚       β”β”€β”€ {Entity}Repository.java           # Repository μΈν„°νμ΄μ¤
β”‚       β””β”€β”€ InMemory{Entity}Repository.java   # μΈλ©”λ¨λ¦¬ κµ¬ν„μ²΄
β”β”€β”€ common/                      # κ³µν†µ λ¨λ“
β”‚   β”β”€β”€ exception/               # κ³µν†µ μμ™Έ μ²λ¦¬
β”‚   β””β”€β”€ response/                # κ³µν†µ μ‘λ‹µ ν•μ‹
β””β”€β”€ config/                      # μ„¤μ • (Clock λ“±)
```

### μ£Όμ” μ„¤κ³„ κ²°μ •

#### 1. λ„λ©”μΈλ³„ ν¨ν‚¤μ§€ κµ¬μ΅°

**μ„ νƒν• λ°©μ‹**: λ„λ©”μΈλ³„λ΅ ν¨ν‚¤μ§€λ¥Ό λ¶„λ¦¬ν•κ³ , κ° λ„λ©”μΈ λ‚΄μ—μ„ κ³„μΈµμ„ κµ¬λ¶„

**μ„ νƒ μ΄μ **:
- λ„λ©”μΈ μ‘μ§‘λ„ ν–¥μƒ: κ΄€λ ¨λ μ½”λ“κ°€ ν• κ³³μ— λ¨μ—¬ μμ–΄ μ΄ν•΄μ™€ μμ •μ΄ μ©μ΄
- ν™•μ¥μ„±: μƒλ΅μ΄ λ„λ©”μΈ μ¶”κ°€ μ‹ κΈ°μ΅΄ μ½”λ“μ— μν–¥ μµμ†ν™”
- ν€ ν‘μ—…: λ„λ©”μΈλ³„λ΅ μ‘μ—… λ¶„λ¦¬κ°€ λ…ν™•

**νΈλ μ΄λ“μ¤ν”„**:
- κ³„μΈµλ³„ ν¨ν‚¤μ§€ κµ¬μ΅° λ€λΉ„ κ³„μΈµ κ°„ μμ΅΄μ„±μ„ νμ•…ν•κΈ° μ–΄λ ¤μΈ μ μμ
- ν•μ§€λ§ λ„λ©”μΈ ν¬κΈ°κ°€ μ‘μ„ λ•λ” λ„λ©”μΈλ³„ κµ¬μ΅°κ°€ λ” μ§κ΄€μ 

#### 2. Repository μΈν„°νμ΄μ¤μ™€ μΈλ©”λ¨λ¦¬ κµ¬ν„ λ¶„λ¦¬

**μ„ νƒν• λ°©μ‹**: Repository μΈν„°νμ΄μ¤λ¥Ό μ •μν•κ³  `InMemory*Repository` κµ¬ν„μ²΄ μ κ³µ

```java
public interface ProductRepository {
    Product save(Product product);
    Optional<Product> findById(Long id);
    List<Product> findAll();
}

@Repository
public class InMemoryProductRepository implements ProductRepository {
    private final ConcurrentHashMap<Long, Product> store = new ConcurrentHashMap<>();
    // ...
}
```

**μ„ νƒ μ΄μ **:
- ν…μ¤νΈ μ©μ΄μ„±: Service ν…μ¤νΈ μ‹ Repositoryλ¥Ό MockμΌλ΅ λ€μ²΄ κ°€λ¥
- ν–¥ν›„ ν™•μ¥: JPA λ“± μ‹¤μ  DB κµ¬ν„μΌλ΅ μ „ν™ μ‹ μΈν„°νμ΄μ¤λ§ μ μ§€ν•λ©΄ λ¨
- μμ΅΄μ„± μ—­μ „: Serviceκ°€ κµ¬μ²΄μ μΈ μ €μ¥μ† κµ¬ν„μ— μμ΅΄ν•μ§€ μ•μ

**νΈλ μ΄λ“μ¤ν”„**:
- μ΄κΈ° κµ¬ν„ λ³µμ΅λ„ μ¦κ°€ (μΈν„°νμ΄μ¤ + κµ¬ν„μ²΄)
- ν•μ§€λ§ μ μ§€λ³΄μμ„±κ³Ό ν…μ¤νΈ μ©μ΄μ„± λ©΄μ—μ„ μ¶©λ¶„ν κ°€μΉ μμ

#### 3. λ‚™κ΄€μ  λ½(@Version)μ„ ν™μ©ν• λ™μ‹μ„± μ μ–΄ μ¤€λΉ„

**μ„ νƒν• λ°©μ‹**: μ¬κ³  μ°¨κ°, ν¬μΈνΈ μ‚¬μ© λ“±μ— `@Version` ν•„λ“ μ¶”κ°€

```java
@Entity
public class Product {
    @Version
    private Long version;

    public void decreaseStock(int quantity) {
        // μ¬κ³  μ°¨κ° λ΅μ§
        // version ν•„λ“λ΅ λ‚™κ΄€μ  λ½ μ μ© (OptimisticLockException λ°μƒ κ°€λ¥)
    }
}
```

**μ„ νƒ μ΄μ **:
- μ„±λ¥: λΉ„κ΄€μ  λ½ λ€λΉ„ μ½κΈ° μ„±λ¥μ΄ μ°μ
- ν™•μ¥μ„±: μ‹¤μ  DB λ„μ… μ‹ JPAμ @Versionκ³Ό νΈν™
- μ¶©λ κ°μ§€: λ™μ‹ μμ • μ‹ μμ™Έ λ°μƒμΌλ΅ λ°μ΄ν„° μ •ν•©μ„± λ³΄μ¥

**νΈλ μ΄λ“μ¤ν”„**:
- μ¶©λ λ°μƒ μ‹ μ¬μ‹λ„ λ΅μ§ ν•„μ”
- μ¶©λμ΄ λΉλ²ν• κ²½μ° μ„±λ¥ μ €ν• κ°€λ¥

#### 4. Clock μ£Όμ…μ„ ν†µν• μ‹κ°„ μ²λ¦¬

**μ„ νƒν• λ°©μ‹**: `java.time.Clock`μ„ DIλ΅ μ£Όμ…λ°›μ•„ μ‹κ°„ μ²λ¦¬

```java
@Service
public class OrderService {
    private final Clock clock;

    public PaymentResult processPayment(PaymentCommand command) {
        Instant now = Instant.now(clock);  // ν…μ¤νΈ κ°€λ¥ν• μ‹κ°„
        // ...
    }
}
```

**μ„ νƒ μ΄μ **:
- ν…μ¤νΈ μ©μ΄μ„±: ν…μ¤νΈμ—μ„ κ³ μ •λ μ‹κ°„ μ£Όμ… κ°€λ¥
- μ‹κ°„ κ΄€λ ¨ λ²„κ·Έ λ°©μ§€: `Instant.now()` μ§μ ‘ νΈμ¶ μ‹ ν…μ¤νΈ μ–΄λ ¤μ›€
- μΌκ΄€μ„±: λ¨λ“  μ‹κ°„ μ²λ¦¬λ¥Ό Clockμ„ ν†µν•΄ μν–‰

**νΈλ μ΄λ“μ¤ν”„**:
- μ΄κΈ° μ„¤μ • λ³µμ΅λ„ μ¦κ°€
- ν•μ§€λ§ μ‹κ°„ μμ΅΄μ μΈ λ΅μ§(λ§λ£, μ ν¨κΈ°κ°„) ν…μ¤νΈμ— ν•„μμ 

#### 5. DTO λ¶„λ¦¬ (Controller DTO vs Service DTO)

**μ„ νƒν• λ°©μ‹**: Controllerμ™€ Serviceμ—μ„ μ‚¬μ©ν•λ” DTOλ¥Ό λ¶„λ¦¬

- **Controller DTO**: `*Request`, `*Response` - API λ…μ„Έμ™€ 1:1 λ§¤μΉ­
- **Service DTO**: `*Command`, `*Query`, `*Result` - λΉ„μ¦λ‹μ¤ λ΅μ§ ν‘ν„

**μ„ νƒ μ΄μ **:
- κ³„μΈµ κ°„ κ²°ν•©λ„ κ°μ†: API λ³€κ²½μ΄ Service λ΅μ§μ— μν–¥ μ—†μ
- λ…ν™•ν• μ±…μ„ λ¶„λ¦¬: Controllerλ” λ³€ν™λ§, Serviceλ” λΉ„μ¦λ‹μ¤ λ΅μ§λ§
- ν…μ¤νΈ λ…λ¦½μ„±: Service ν…μ¤νΈκ°€ HTTP μ‘λ‹µ ν•μ‹μ— μμ΅΄ν•μ§€ μ•μ

**νΈλ μ΄λ“μ¤ν”„**:
- μ½”λ“λ‰ μ¦κ°€ (DTO ν΄λμ¤ 2λ°°)
- λ³€ν™ λ΅μ§ ν•„μ” (from/to λ©”μ„λ“)
- ν•μ§€λ§ μ¥κΈ°μ μΌλ΅ μ μ§€λ³΄μμ„± ν–¥μƒ

#### 6. ConcurrentHashMap μ‚¬μ©

**μ„ νƒν• λ°©μ‹**: μΈλ©”λ¨λ¦¬ μ €μ¥μ†μ— `ConcurrentHashMap` μ‚¬μ©

**μ„ νƒ μ΄μ **:
- μ¤λ λ“ μ•μ „μ„±: λ©€ν‹°μ¤λ λ“ ν™κ²½μ—μ„ λ™μ‹ μ ‘κ·Ό μ•μ „
- μ„±λ¥: HashMap λ€λΉ„ μ•½κ°„μ μ¤λ²„ν—¤λ“λ΅ λ™μ‹μ„± μ§€μ›
- ν–¥ν›„ ν™•μ¥: λ™μ‹μ„± ν…μ¤νΈ μ‹λ‚λ¦¬μ¤ λ€μ‘ κ°€λ¥

**νΈλ μ΄λ“μ¤ν”„**:
- λ‹¨μΌ μ¤λ λ“ ν™κ²½μ—μ„λ” HashMapλ³΄λ‹¤ μ•½κ°„ λλ¦Ό
- ν•μ§€λ§ κ³Όμ  μ”κµ¬μ‚¬ν•­(λ™μ‹μ„± μ μ–΄)μ„ κ³ λ ¤ν•λ©΄ ν•„μμ 

## π“ ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€

```bash
./gradlew test jacocoTestReport
```

| ν•­λ© | κ²°κ³Ό |
|------|------|
| μ „μ²΄ μ»¤λ²„λ¦¬μ§€ | 53% |
| λ‹¨μ„ ν…μ¤νΈ | 92κ° ν†µκ³Ό |
| ν†µν•© ν…μ¤νΈ | 0κ° (Controller λ μ΄μ–΄ λ―Έν…μ¤νΈ) |

### λ„λ©”μΈλ³„ μ»¤λ²„λ¦¬μ§€

| λ„λ©”μΈ | μ»¤λ²„λ¦¬μ§€ | μ£Όμ” ν…μ¤νΈ |
|--------|----------|------------|
| CartService | 91% | μ¥λ°”κµ¬λ‹ μ¶”κ°€/μ΅°ν/μ‚­μ  |
| PointService | 100% | ν¬μΈνΈ μ¶©μ „/μ‚¬μ©/μ΅°ν |
| ProductService | 91% | μƒν’ μ΅°ν/μ¬κ³ /μΈκΈ°μƒν’ |
| CouponService | 93% | μΏ ν° λ°κΈ‰/μ‚¬μ©/μ΅°ν |
| OrderService | 72% | μ£Όλ¬Έ/κ²°μ /ν™λ¶/μ·¨μ† |

### μ»¤λ²„λ¦¬μ§€κ°€ 70%μ— λ―Έλ‹¬ν•λ” μ΄μ 

- **Controller λ μ΄μ–΄**: 0% (ν†µν•© ν…μ¤νΈ λ―Έμ‘μ„±)
- **DTO ν΄λμ¤**: λ€λ¶€λ¶„ 0% (λ‹¨μ λ°μ΄ν„° ν΄λμ¤)
- **Infrastructure**: μΌλ¶€λ§ ν…μ¤νΈ (InMemory κµ¬ν„μ²΄)

**μ„λΉ„μ¤ λ μ΄μ–΄λ” ν‰κ·  89% μ΄μƒ**μΌλ΅ μ¶©λ¶„ν• ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€λ¥Ό ν™•λ³΄ν–μµλ‹λ‹¤.

## π€ μ‹¤ν–‰ λ°©λ²•

### λΉλ“ λ° ν…μ¤νΈ

```bash
# λΉλ“
./gradlew build

# ν…μ¤νΈ μ‹¤ν–‰
./gradlew test

# μ»¤λ²„λ¦¬μ§€ λ¦¬ν¬νΈ μƒμ„±
./gradlew jacocoTestReport

# μ»¤λ²„λ¦¬μ§€ λ¦¬ν¬νΈ ν™•μΈ
open build/reports/jacoco/test/html/index.html
```

### μ• ν”λ¦¬μΌ€μ΄μ… μ‹¤ν–‰

```bash
./gradlew bootRun
```

μ„λ²„κ°€ `http://localhost:8080`μ—μ„ μ‹¤ν–‰λ©λ‹λ‹¤.

## π“ API λ…μ„Έ

### ν¬μΈνΈ API

- `GET /users/{userId}/point` - ν¬μΈνΈ μ”μ•΅ μ΅°ν
- `POST /users/{userId}/point/charge` - ν¬μΈνΈ μ¶©μ „
- `GET /users/{userId}/point/history` - ν¬μΈνΈ λ‚΄μ—­ μ΅°ν

### μƒν’ API

- `GET /products` - μƒν’ λ©λ΅ μ΅°ν
- `GET /products/{productId}` - μƒν’ μƒμ„Έ μ΅°ν
- `GET /products/{productId}/stock` - μƒν’ μ¬κ³  μ΅°ν
- `GET /products/top` - μΈκΈ° μƒν’ μ΅°ν

### μ¥λ°”κµ¬λ‹ API

- `GET /users/{userId}/cart` - μ¥λ°”κµ¬λ‹ μ΅°ν
- `POST /users/{userId}/cart` - μ¥λ°”κµ¬λ‹ μ¶”κ°€
- `DELETE /users/{userId}/cart/{productId}` - μ¥λ°”κµ¬λ‹ μ‚­μ 

### μ£Όλ¬Έ API

- `POST /users/{userId}/orders` - μ£Όλ¬Έ μƒμ„±
- `GET /users/{userId}/orders` - μ£Όλ¬Έ λ©λ΅ μ΅°ν
- `GET /users/{userId}/orders/{orderId}` - μ£Όλ¬Έ μƒμ„Έ μ΅°ν
- `POST /users/{userId}/orders/{orderId}/payment` - κ²°μ  μ²λ¦¬
- `POST /users/{userId}/orders/{orderId}/refund` - ν™λ¶ μ²λ¦¬
- `POST /users/{userId}/orders/{orderId}/cancel` - μ£Όλ¬Έ μ·¨μ†

### μΏ ν° API

- `POST /users/{userId}/coupons/{couponId}` - μΏ ν° λ°κΈ‰
- `GET /users/{userId}/coupons` - λ³΄μ  μΏ ν° μ΅°ν

## π”’ λ™μ‹μ„± μ μ–΄ (STEP 6)

### ν„μ¬ μ μ©λ λ°©μ‹

1. **λ‚™κ΄€μ  λ½ (@Version)**
   - Product.decreaseStock() - μ¬κ³  μ°¨κ°
   - User.use() / User.charge() - ν¬μΈνΈ μ‚¬μ©/μ¶©μ „
   - Coupon.incrementIssuedQuantity() - μΏ ν° λ°κΈ‰ μλ‰ μ¦κ°€

2. **ConcurrentHashMap**
   - λ¨λ“  μΈλ©”λ¨λ¦¬ μ €μ¥μ†μ— μ μ©
   - λ©€ν‹°μ¤λ λ“ ν™κ²½μ—μ„ μ•μ „ν• CRUD μ‘μ—…

### ν–¥ν›„ κ³„ν (STEP 6 μ‹¬ν™”)

- μ„ μ°©μ μΏ ν° λ°κΈ‰ λ™μ‹μ„± ν…μ¤νΈ μ¶”κ°€
- μ¬κ³  μ°¨κ° Race Condition μ‹λ‚λ¦¬μ¤ ν…μ¤νΈ
- λ‚™κ΄€μ  λ½ μ‹¤ν¨ μ‹ μ¬μ‹λ„ λ΅μ§ κµ¬ν„

## π― μ²΄ν¬λ¦¬μ¤νΈ

### β… STEP 5 μ™„λ£ ν•­λ©

- [x] λ„λ©”μΈ λ¨λΈ κµ¬ν„ (User, Product, Order, Coupon, Cart λ“±)
- [x] μ μ¤μΌ€μ΄μ¤ κµ¬ν„ (ν¬μΈνΈ, μƒν’, μ¥λ°”κµ¬λ‹, μ£Όλ¬Έ, μΏ ν°)
- [x] λ μ΄μ–΄λ“ μ•„ν‚¤ν…μ² (λ„λ©”μΈλ³„ Controller-Service-Domain-Infrastructure)
- [x] μ¬κ³  κ΄€λ¦¬ (μ΅°ν/μ°¨κ°/λ³µκµ¬)
- [x] μ£Όλ¬Έ/κ²°μ  (μƒμ„±/κ²°μ /ν™λ¶/μ·¨μ†)
- [x] μ„ μ°©μ μΏ ν° (λ°κΈ‰/μ‚¬μ©/λ§λ£ λ΅μ§)
- [x] λ‹¨μ„ ν…μ¤νΈ (92κ°, μ„λΉ„μ¤ λ μ΄μ–΄ 89% ν‰κ·  μ»¤λ²„λ¦¬μ§€)

### π”¥ STEP 6 μ§„ν–‰ μμ •

- [ ] λ™μ‹μ„± μ μ–΄ ν†µν•© ν…μ¤νΈ
- [ ] μ„ μ°©μ μΏ ν° Race Condition ν…μ¤νΈ
- [ ] λ‚™κ΄€μ  λ½ μ¬μ‹λ„ λ΅μ§
- [ ] μΈκΈ° μƒν’ μ§‘κ³„ κ³ λ„ν™”

## π“ κΈ°μ  μ¤νƒ

- **Language**: Java 17
- **Framework**: Spring Boot 3.5.7
- **Build Tool**: Gradle
- **Test**: JUnit 5, Mockito, AssertJ
- **Coverage**: JaCoCo

## π¤” νκ³ 

### β¨ μν• μ 

- λ„λ©”μΈλ³„ ν¨ν‚¤μ§€ κµ¬μ΅°λ΅ μ‘μ§‘λ„ λ†’μ€ μ„¤κ³„
- Repository μΈν„°νμ΄μ¤ λ¶„λ¦¬λ΅ ν…μ¤νΈ μ©μ΄μ„± ν™•λ³΄
- Service λ μ΄μ–΄ λ‹¨μ„ ν…μ¤νΈ μ¶©μ‹¤ (ν‰κ·  89% μ»¤λ²„λ¦¬μ§€)
- Clock μ£Όμ…μΌλ΅ μ‹κ°„ μμ΅΄μ  λ΅μ§ ν…μ¤νΈ κ°€λ¥
- DTO λ¶„λ¦¬λ΅ κ³„μΈµ κ°„ κ²°ν•©λ„ κ°μ†

### π“ μ–΄λ ¤μ› λ μ 

- μΈλ©”λ¨λ¦¬ μ €μ¥μ†μ—μ„ λ‚™κ΄€μ  λ½ μ‹λ®¬λ μ΄μ…
- ν†µν•© ν…μ¤νΈ μ—†μ΄ 70% μ»¤λ²„λ¦¬μ§€ λ‹¬μ„± μ–΄λ ¤μ›€
- Controller DTOμ™€ Service DTO λ¶„λ¦¬λ΅ μΈν• μ½”λ“λ‰ μ¦κ°€

### π€ λ‹¤μμ— μ‹λ„ν•  κ²ƒ

- Controller ν†µν•© ν…μ¤νΈ μ¶”κ°€λ΅ 70% μ΄μƒ μ»¤λ²„λ¦¬μ§€ λ‹¬μ„±
- λ™μ‹μ„± ν…μ¤νΈ μ‹λ‚λ¦¬μ¤ μ‘μ„± λ° κ²€μ¦
- μ‹¤μ  DB(JPA) μ „ν™ μ‹ Repository μΈν„°νμ΄μ¤ μ μ§€ κ²€μ¦